<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowWrite Refactor Test</title>
</head>
<body>
    <h1>FlowWrite AI Provider Manager Refactor Test</h1>
    <p>Testing the refactored requestSuggestion() function with provider-agnostic API calls and retry logic.</p>

    <div>
        <h2>Test Cases</h2>
        <ul>
            <li>✅ AIProviderManager class with multi-provider support (Gemini, Cerebras, Groq)</li>
            <li>✅ Async loadConfiguration() method for providers from chrome.storage</li>
            <li>✅ Provider selection with selectBestProvider() based on failure counts</li>
            <li>✅ Automatic provider switching with switchToNextProvider()</li>
            <li>✅ Provider-agnostic API calls (Gemini API + OpenAI-compatible API)</li>
            <li>✅ Retry logic with exponential backoff (3 attempts)</li>
            <li>✅ Automatic model fallback within provider</li>
            <li>✅ User-visible error indicators with showPersistentErrorIndicator()</li>
            <li>✅ Backward compatibility with legacy apiKey configuration</li>
        </ul>

        <h2>Key Features</h2>
        <ul>
            <li><strong>Multi-Provider Support:</strong> Gemini, Cerebras, Groq with API key and model configuration per provider</li>
            <li><strong>Automatic Fallback:</strong> Rotates models within provider, then switches to next enabled provider</li>
            <li><strong>Retry Logic:</strong> 3 attempts with exponential backoff (1s, 2s, 4s max 5s)</li>
            <li><strong>Error Visibility:</strong> Persistent error indicator with clickable tooltip showing failure details</li>
            <li><strong>Backward Compatibility:</strong> Legacy apiKey configuration migrated to Gemini provider automatically</li>
        </ul>

        <h2>Test Text Field</h2>
        <textarea rows="5" cols="50" placeholder="Type here to test suggestions..."></textarea>
    </div>

    <script src="extension/debug-utils.js"></script>
    <script src="extension/mutation-observer.js"></script>
    <script src="extension/ai-provider-manager.js"></script>
    <script>
        // Mock chrome.storage API for testing
        if (typeof chrome === 'undefined') {
            window.chrome = {
                storage: {
                    local: {
                        get: function(keys, callback) {
                            // Simulate stored configuration
                            const mockData = {
                                apiKey: 'test-legacy-key',
                                providers: {
                                    gemini: {
                                        enabled: true,
                                        apiKey: 'test-gemini-key',
                                        model: 'gemini-2.0-flash-exp'
                                    },
                                    cerebras: {
                                        enabled: false,
                                        apiKey: '',
                                        model: 'llama3.1-8b'
                                    },
                                    groq: {
                                        enabled: false,
                                        apiKey: '',
                                        model: 'llama-3.3-70b-versatile'
                                    }
                                }
                            };
                            callback(mockData);
                        }
                    }
                },
                runtime: {
                    getURL: function(path) {
                        return path;
                    }
                }
            };
        }

        // Test the AIProviderManager
        async function testAIProviderManager() {
            const manager = new AIProviderManager();
            await manager.loadConfiguration();

            console.log('Current Provider:', manager.currentProvider);
            console.log('Current Model:', manager.getCurrentModel());
            console.log('Providers:', manager.providers);

            // Test provider selection
            console.log('Best Provider:', manager.selectBestProvider());

            // Test model rotation
            console.log('Simulating failures...');
            manager.recordFailure();
            manager.recordFailure();
            console.log('Should rotate?', manager.shouldRotateModel());
            console.log('Next model:', manager.getNextModel());

            // Test provider switching
            console.log('Switching to next provider:', manager.switchToNextProvider());
        }

        testAIProviderManager().then(() => {
            console.log('AIProviderManager test completed!');
        });
    </script>
</body>
</html>
